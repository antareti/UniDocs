<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор университетских документов</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- jsPDF library for generating PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Адаптивные стили для контейнера предварительного просмотра */
        .preview-container {
            transition: all 0.3s ease-in-out;
            filter: blur(5px);
            opacity: 0.5;
            transform: scale(0.98);
        }

        .preview-container.visible {
            filter: blur(0);
            opacity: 1;
            transform: scale(1);
        }
        
        /* Стили для кастомного окошка с сообщением */
        #message-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* Стили для печати */
        @media print {
            body {
                background-color: #fff;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div class="flex flex-col lg:flex-row w-full min-h-screen">
        <!-- Левая панель: элементы управления -->
        <div class="w-full lg:w-1/3 bg-slate-800 p-6 lg:p-8 shadow-lg no-print">
            <div class="flex items-center mb-6">
                <img src="https://i.postimg.cc/mD8r4fKj/HACKPACK.png" alt="Логотип HACKPACK" class="h-12 w-12 mr-4">
                <h1 class="text-2xl font-bold text-slate-100">Генератор документов от HACKPACK</h1>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="college-name" class="block text-sm font-medium text-slate-400">Название университета</label>
                    <input type="text" id="college-name" readonly class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none sm:text-sm text-slate-400">
                </div>
                <div>
                    <label for="student-name" class="block text-sm font-medium text-slate-400">Имя студента</label>
                    <input type="text" id="student-name" readonly class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none sm:text-sm text-slate-400">
                </div>
                <div>
                    <label for="enrollment-no" class="block text-sm font-medium text-slate-400">Номер зачетной книжки</label>
                    <input type="text" id="enrollment-no" readonly class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none sm:text-sm text-slate-400">
                </div>
                <div>
                    <label for="program-name" class="block text-sm font-medium text-slate-400">Специальность</label>
                    <input type="text" id="program-name" readonly class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-md shadow-sm py-2 px-3 focus:outline-none sm:text-sm text-slate-400">
                </div>
            </div>

            <div class="mt-8 space-y-3">
                <button id="generate-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors duration-200">
                    <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="btn-text">Сгенерировать документы</span>
                </button>
                <button id="save-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors duration-200 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span>Сохранить все документы (.zip)</span>
                </button>
                <div id="status-text" class="text-center text-slate-400 text-sm h-5"></div>
            </div>
        </div>

        <!-- Правая панель: Предпросмотр -->
        <div class="w-full lg:w-2/3 bg-slate-900 p-6 lg:p-8 overflow-y-auto">
            <h2 class="text-xl font-bold mb-6 text-slate-100">Предпросмотр документов</h2>
            <div id="previews-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">

                <!-- Предпросмотр удостоверения личности -->
                <div id="preview-id-card-wrapper" class="preview-container">
                    <h3 class="font-semibold mb-2 text-slate-200">УДОСТОВЕРЕНИЕ ЛИЧНОСТИ</h3>
                    <div id="id-card-content" class="relative bg-slate-800 p-4 rounded-lg max-w-sm mx-auto h-[180px] flex items-center justify-start space-x-4 border border-slate-700">
                        <!-- Логотип и название университета в верхнем левом углу -->
                        <div class="absolute top-3 left-4 flex items-center space-x-2">
                            <img id="id-card-logo" src="https://placehold.co/32x32/1a202c/e2e8f0?text=ЛОГО" class="rounded-full w-8 h-8 object-contain" alt="Логотип университета">
                            <h4 id="id-card-university" class="font-bold text-base text-slate-200"></h4>
                        </div>
                        <!-- Полупрозрачная печать в верхнем правом углу -->
                        <img src="https://placehold.co/40x40/1a202c/e2e8f0?text=ПЕЧАТЬ" class="absolute top-3 right-4 opacity-20 w-10 h-10 object-contain" alt="Печать университета">

                        <!-- Фото студента -->
                        <img id="id-card-photo" src="https://placehold.co/80x100/2d3748/cbd5e0?text=Загрузка..." class="w-20 h-24 rounded-md border border-slate-500 object-cover mt-8 ml-4 animate-pulse" alt="Фото студента">

                        <!-- Данные студента -->
                        <div class="flex flex-col text-[10px] text-slate-200 mt-8">
                            <p class="mb-1"><strong>N.º DE MATRÍCULA</strong> <span id="id-card-enroll" class="font-medium"></span></p>
                            <p class="mb-1"><strong>NOME</strong> <span id="id-card-name" class="font-semibold text-xs"></span></p>
                            <p class="mb-1"><strong>CURSO</strong> <span id="id-card-program" class="font-medium"></span></p>
                            <div class="flex justify-between w-full mt-2">
                                <p><strong>DATA DE NASCIMENTO</strong> <span id="id-card-dob" class="font-medium"></span></p>
                                <p><strong>VÁLIDO ATÉ</strong> <span id="id-card-valid-thru" class="font-medium"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Предпросмотр файла данных -->
                <div id="preview-data-file-wrapper" class="preview-container">
                    <h3 class="font-semibold mb-2 text-slate-200">Файл данных (info.txt)</h3>
                    <div class="bg-slate-800 text-slate-200 p-4 rounded-lg shadow-md font-mono text-xs">
                        <pre id="data-file-content"></pre>
                    </div>
                </div>

                <!-- Предпросмотр квитанции об оплате -->
                <div id="preview-fee-receipt-wrapper" class="preview-container">
                    <h3 class="font-semibold mb-2 text-slate-200">КВИТАНЦИЯ ОБ ОПЛАТЕ</h3>
                    <div id="fee-receipt-content" class="bg-slate-800 p-8 rounded-lg max-w-md mx-auto relative border border-slate-700">
                        <div class="text-center mb-8">
                            <img id="receipt-logo" src="https://placehold.co/64x64/1a202c/e2e8f0?text=ЛОГО" class="h-16 mx-auto mb-4 object-contain" alt="Логотип университета">
                            <h4 id="receipt-university" class="font-bold text-xl text-slate-200"></h4>
                            <p class="text-sm text-slate-400">RECIBO DE PROPINAS</p>
                        </div>
                        <div class="flex justify-between text-sm mb-6 text-slate-200">
                            <div>
                                <p><strong>Data:</strong> <span id="receipt-date"></span></p>
                                <p><strong>N.º de Matrícula:</strong> <span id="receipt-enroll"></span></p>
                            </div>
                            <div>
                                <p><strong>Nome:</strong> <span id="receipt-name"></span></p>
                                <p><strong>Curso:</strong> <span id="receipt-program"></span></p>
                            </div>
                        </div>
                        <div class="border-t border-b border-slate-600 py-4 mb-4 text-slate-200">
                            <h5 class="text-sm font-semibold mb-2">Finalidade do Pagamento:</h5>
                            <p class="text-xs">Propinas e outras taxas para o semestre de 2024-2025.</p>
                        </div>
                        <table class="w-full text-sm text-slate-200">
                            <thead>
                                <tr class="border-b-2 border-t border-slate-700">
                                    <th class="text-left py-2">Detalhamento</th>
                                    <th class="text-right py-2">Montante (R$)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b border-slate-700">
                                    <td class="py-2">Propinas e Outras Taxas</td>
                                    <td id="receipt-amount" class="text-right py-2"></td>
                                </tr>
                                <tr>
                                    <td class="py-2 font-bold">Total Pago</td>
                                    <td id="receipt-total" class="text-right py-2 font-bold"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mt-12 text-right text-sm relative">
                            <img id="receipt-signature" src="https://placehold.co/300x100/2d3748/cbd5e0?text=Загрузка..." class="absolute bottom-10 right-0 w-36 h-12 object-contain animate-pulse z-10" alt="Авторизованная подпись">
                            <p class="relative z-0 text-slate-200">____________________</p>
                            <p class="mt-1 relative z-0 text-slate-200">Assinatura Autorizada</p>
                        </div>
                    </div>
                </div>

                <!-- Предпросмотр расписания занятий -->
                <div id="preview-schedule-wrapper" class="preview-container">
                    <h3 class="font-semibold mb-2 text-slate-200">РАСПИСАНИЕ ЗАНЯТИЙ</h3>
                    <div id="class-schedule-content" class="bg-slate-800 p-8 rounded-lg max-w-md mx-auto relative border border-slate-700">
                        <div class="text-center mb-6 border-b border-slate-700 pb-4">
                            <img id="schedule-logo" src="https://placehold.co/48x48/1a202c/e2e8f0?text=ЛОГО" class="h-12 mx-auto mb-2 object-contain" alt="Логотип университета">
                            <h4 id="schedule-university" class="font-bold text-lg text-slate-200"></h4>
                            <p class="font-semibold text-slate-400 mt-2">HORÁRIO DE AULAS</p>
                        </div>
                        <div class="text-xs mb-4 text-slate-200">
                            <p><strong>Nome do Aluno:</strong> <span id="schedule-name"></span></p>
                            <p><strong>N.º de Matrícula:</strong> <span id="schedule-enroll"></span></p>
                            <p><strong>Semestre:</strong> <span id="schedule-semester"></span></p>
                            <p><strong>Data de Emissão:</strong> <span id="schedule-date"></span></p>
                        </div>
                        <table class="w-full text-sm text-slate-200">
                            <thead>
                                <tr class="border-b-2 border-t border-slate-700">
                                    <th class="text-left py-2 px-2 border-b">CÓDIGO DA UNIDADE</th>
                                    <th class="text-left py-2 px-2 border-b">NOME DA UNIDADE</th>
                                    <th class="text-left py-2 px-2 border-b">LOCAL</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-courses-tbody">
                                <!-- Курсы будут добавлены здесь -->
                            </tbody>
                        </table>
                        <div class="mt-12 text-right text-sm relative">
                            <img id="schedule-signature" src="https://placehold.co/300x100/2d3748/cbd5e0?text=Загрузка..." class="absolute bottom-10 right-0 w-36 h-12 object-contain animate-pulse z-10" alt="Авторизованная подпись">
                            <p class="relative z-0 text-slate-200">____________________</p>
                            <p class="mt-1 relative z-0 text-slate-200">Assinatura Autorizada</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Модальное окно подписки -->
    <div id="subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 text-slate-200 p-8 rounded-lg shadow-xl text-center max-w-sm mx-auto">
            <h3 class="text-xl font-bold mb-4">Почти готово!</h3>
            <p class="text-slate-400 mb-6">Сначала подпишись на канал HACKPACK, чтобы скачать документы.</p>
            <div class="space-y-3">
                <a href="https://t.me/+12jRx8pnmI03MzNi" target="_blank" class="block w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200">
                    Подписаться
                </a>
                <button id="confirm-subscription-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-200">
                    Я подписался
                </button>
            </div>
        </div>
    </div>


    <!-- Кастомное окошко с сообщением -->
    <div id="message-box" class="fixed bottom-5 right-5 bg-red-800 border-red-600 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transform translate-y-2 max-w-sm hidden">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // --- ДАННЫЕ ДЛЯ ГЕНЕРАЦИИ ---
        const brazilianUniversities = [
            "Universidade de São Paulo (USP)",
            "Universidade Estadual de Campinas (UNICAMP)",
            "Universidade Federal do Rio de Janeiro (UFRJ)",
            "Universidade Federal de Minas Gerais (UFMG)",
            "Universidade Federal do Rio Grande do Sul (UFRGS)",
            "Universidade Federal de Santa Catarina (UFSC)",
            "Universidade Federal de Pernambuco (UFPE)",
            "Universidade Federal da Bahia (UFBA)",
            "Universidade de Brasília (UnB)",
            "Pontifícia Universidade Católica de São Paulo (PUC-SP)",
            "Fundação Getulio Vargas (FGV)",
            "Insper Instituto de Ensino e Pesquisa"
        ];

        const firstNames = [
            "João", "Pedro", "Francisco", "José", "António", "Carlos", "Miguel", "Tiago",
            "Gonçalo", "Diogo", "Rui", "Nuno", "Ricardo", "Paulo", "Alexandre", "David",
            "André", "Bruno", "Eduardo", "Filipe", "Gustavo", "Hugo", "Jorge", "Luís"
        ];
        const femaleFirstNames = [
            "Maria", "Ana", "Leonor", "Beatriz", "Mariana", "Inês", "Sofia", "Catarina",
            "Joana", "Matilde", "Francisca", "Sara", "Carolina", "Diana", "Cláudia", "Filipa",
            "Helena", "Isabel", "Júlia", "Laura", "Marta", "Patrícia", "Sandra", "Susana"
        ];
        const lastNames = [
            "Silva", "Santos", "Ferreira", "Pereira", "Oliveira", "Costa", "Rodrigues", "Martins",
            "Jesus", "Sousa", "Fernandes", "Gonçalves", "Gomes", "Lopes", "Marques", "Alves",
            "Ribeiro", "Pinto", "Carvalho", "Tavares", "Correia", "Nunes", "Soares", "Cunha"
        ];
        const programs = [
            "Engenharia Informática", "Medicina", "Direito", "Arquitetura", "Gestão",
            "Psicologia", "Economia", "Ciências da Comunicação", "Engenharia Civil", "Ciências Biomédicas"
        ];
        const courses = [
            { code: 'ENG-101', name: 'Matemática I', location: 'Sala 101' },
            { code: 'INF-102', name: 'Introdução à Programação', location: 'Lab. Informática' },
            { code: 'FIS-101', name: 'Física Clássica', location: 'Sala 203' },
            { code: 'DIR-201', name: 'Direito Constitucional', location: 'Sala 105' },
            { code: 'MED-301', name: 'Anatomia Humana', location: 'Anfiteatro' },
            { code: 'GES-202', name: 'Contabilidade Financeira', location: 'Sala 302' },
            { code: 'ARQ-103', name: 'Desenho de Arquitetura', location: 'Atelier I' },
            { code: 'PSI-204', name: 'Psicologia do Desenvolvimento', location: 'Sala 207' }
        ];
        const deptCodes = ["ENG", "DIR", "MED", "INF", "GES", "ARQ", "ECO", "COM"];

        // --- Элементы UI ---
        const generateBtn = document.getElementById('generate-btn');
        const saveBtn = document.getElementById('save-btn');
        const btnText = document.getElementById('btn-text');
        const spinner = document.getElementById('spinner');
        const statusText = document.getElementById('status-text');
        const modal = document.getElementById('subscription-modal');
        const confirmSubscriptionBtn = document.getElementById('confirm-subscription-btn');

        // Поля ввода
        const collegeInput = document.getElementById('college-name');
        const nameInput = document.getElementById('student-name');
        const enrollInput = document.getElementById('enrollment-no');
        const programInput = document.getElementById('program-name');

        // Контейнеры предварительного просмотра
        const previewWrappers = document.querySelectorAll('.preview-container');

        // Элементы удостоверения личности
        const idCardUniversity = document.getElementById('id-card-university');
        const idCardName = document.getElementById('id-card-name');
        const idCardEnroll = document.getElementById('id-card-enroll');
        const idCardProgram = document.getElementById('id-card-program');
        const idCardPhoto = document.getElementById('id-card-photo');
        const idCardLogo = document.getElementById('id-card-logo');
        const idCardDob = document.getElementById('id-card-dob');
        const idCardValidThru = document.getElementById('id-card-valid-thru');

        // Элемент файла данных
        const dataFileContent = document.getElementById('data-file-content');
        let currentTxtContent = ''; // Переменная для хранения текста файла .txt

        // Элементы квитанции
        const receiptUniversity = document.getElementById('receipt-university');
        const receiptDate = document.getElementById('receipt-date');
        const receiptEnroll = document.getElementById('receipt-enroll');
        const receiptName = document.getElementById('receipt-name');
        const receiptProgram = document.getElementById('receipt-program');
        const receiptAmount = document.getElementById('receipt-amount');
        const receiptTotal = document.getElementById('receipt-total');
        const receiptLogo = document.getElementById('receipt-logo');
        const receiptSignature = document.getElementById('receipt-signature');

        // Элементы расписания занятий
        const scheduleUniversity = document.getElementById('schedule-university');
        const scheduleName = document.getElementById('schedule-name');
        const scheduleEnroll = document.getElementById('schedule-enroll');
        const scheduleSemester = document.getElementById('schedule-semester');
        const scheduleDate = document.getElementById('schedule-date');
        const scheduleCoursesBody = document.getElementById('schedule-courses-tbody');
        const scheduleLogo = document.getElementById('schedule-logo');
        const scheduleSignature = document.getElementById('schedule-signature');


        // --- Вспомогательные функции ---

        /**
         * Нормализует строку, удаляя диакритические знаки (акценты), для генерации электронной почты.
         * @param {string} str Строка для нормализации.
         * @returns {string} Нормализованная строка только с латинскими символами.
         */
        const normalizeString = (str) => {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, '');
        };

        /**
         * Генерирует изображение с помощью API и обновляет HTML-элемент.
         * @param {string} prompt Подсказка для генерации изображения.
         * @param {HTMLElement} element HTML-элемент <img> для обновления.
         * @param {string} placeholderText Текст заглушки.
         */
        const generateImage = async (prompt, element, placeholderText) => {
            element.src = `https://placehold.co/${element.width}x${element.height}/2d3748/cbd5e0?text=${encodeURIComponent(placeholderText)}`;
            element.classList.add('animate-pulse');

            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    element.src = imageUrl;
                } else {
                    console.error('Ошибка: неверный формат ответа API.');
                    showMessage('Ошибка при генерации изображения. Пожалуйста, попробуйте еще раз.');
                    element.src = `https://placehold.co/${element.width}x${element.height}/ef4444/ffffff?text=Ошибка`;
                }
            } catch (error) {
                console.error('Ошибка при вызове API генерации изображения:', error);
                showMessage('Ошибка при генерации изображения. Пожалуйста, попробуйте еще раз.');
                element.src = `https://placehold.co/${element.width}x${element.height}/ef4444/ffffff?text=Ошибка`;
            } finally {
                element.classList.remove('animate-pulse');
            }
        };


        /**
         * Отображает кастомное окошко с сообщением с анимацией появления/исчезновения.
         * @param {string} message Сообщение для отображения.
         */
        const showMessage = (message) => {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0', 'translate-y-2');
            messageBox.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Дождаться окончания анимации исчезновения
            }, 3000);
        };

        /**
         * Генерирует PDF из данного HTML-элемента.
         * @param {string} elementId ID HTML-элемента для конвертации.
         * @returns {Promise<Blob>} Promise, который разрешается Blob-объектом PDF-файла.
         */
        const generatePdfBlob = async (elementId) => {
            const element = document.getElementById(elementId);
            const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#1e293b' }); // Устанавливаем фон для canvas
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            const { jsPDF } = window.jspdf;

            const elementWidth = element.offsetWidth;
            const elementHeight = element.offsetHeight;
            const orientation = elementWidth > elementHeight ? 'l' : 'p'; // альбомная или книжная ориентация

            // Создать PDF с размерами, соответствующими элементу
            const pdf = new jsPDF(orientation, 'pt', [elementWidth, elementHeight]);

            pdf.addImage(imgData, 'JPEG', 0, 0, elementWidth, elementHeight);
            return pdf.output('blob');
        };

        // --- Основная логика генерации ---
        generateBtn.addEventListener('click', async () => {
            generateBtn.disabled = true;
            saveBtn.disabled = true;
            btnText.textContent = 'Генерация...';
            spinner.classList.remove('hidden');
            statusText.textContent = 'Загрузка данных...';

            // Сброс анимаций предварительного просмотра
            previewWrappers.forEach(el => el.classList.remove('visible'));

            // 1. Сгенерировать случайные данные
            const isMale = Math.random() < 0.5;
            const studentFirstName = isMale ? firstNames[Math.floor(Math.random() * firstNames.length)] : femaleFirstNames[Math.floor(Math.random() * femaleFirstNames.length)];
            const studentLastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const university = brazilianUniversities[Math.floor(Math.random() * brazilianUniversities.length)];
            const program = programs[Math.floor(Math.random() * programs.length)];
            const enrollmentNo = `${deptCodes[Math.floor(Math.random() * deptCodes.length)]}-${Math.floor(1000 + Math.random() * 9000)}-${new Date().getFullYear()}`;
            
            // Сгенерировать дату рождения
            const currentYear = new Date().getFullYear();
            const birthYear = Math.floor(Math.random() * 6) + (currentYear - 23); // Возраст 18-23
            const birthMonth = Math.floor(Math.random() * 12) + 1;
            const birthDay = Math.floor(Math.random() * 28) + 1;
            const dob = `${String(birthDay).padStart(2, '0')}/${String(birthMonth).padStart(2, '0')}/${birthYear}`;

            const email = `${normalizeString(studentFirstName.toLowerCase())}${normalizeString(studentLastName.toLowerCase())}${birthYear}@gmail.com`;

            const validThru = `${new Date().getMonth() + 1}/${new Date().getFullYear() + 4}`;
            const today = new Date().toLocaleDateString('pt-BR');
            const semester = "Semestre 2024-2025";

            // Случайно выбрать 4 курса
            const selectedCourses = [];
            const coursesCopy = [...courses];
            for (let i = 0; i < 4; i++) {
                const randomIndex = Math.floor(Math.random() * coursesCopy.length);
                selectedCourses.push(coursesCopy.splice(randomIndex, 1)[0]);
            }

            // Сгенерировать случайную сумму от 800 до 2000
            const randomAmount = (Math.floor(Math.random() * 1201) + 800);

            // 2. Установить данные в поля ввода и предварительный просмотр
            statusText.textContent = 'Обновление данных...';

            // Поля ввода
            collegeInput.value = university;
            nameInput.value = `${studentFirstName} ${studentLastName}`;
            enrollInput.value = enrollmentNo;
            programInput.value = program;

            // Удостоверение личности
            idCardUniversity.textContent = university;
            idCardName.textContent = `${studentFirstName} ${studentLastName}`.toUpperCase();
            idCardEnroll.textContent = enrollmentNo;
            idCardProgram.textContent = program;
            idCardDob.textContent = dob;
            idCardValidThru.textContent = validThru;

            // Файл данных
            currentTxtContent = `
Nome do Aluno: ${studentFirstName} ${studentLastName}
N.º de Matrícula: ${enrollmentNo}
Curso: ${program}
Universidade: ${university}
Email: ${email}
`;
            dataFileContent.textContent = currentTxtContent.trim();


            // Квитанция
            receiptUniversity.textContent = university;
            receiptDate.textContent = today;
            receiptEnroll.textContent = enrollmentNo;
            receiptName.textContent = `${studentFirstName} ${studentLastName}`;
            receiptProgram.textContent = program;
            receiptAmount.textContent = `R$${randomAmount.toFixed(2)}`;
            receiptTotal.textContent = `R$${randomAmount.toFixed(2)}`;

            // Расписание занятий
            scheduleUniversity.textContent = university;
            scheduleName.textContent = `${studentFirstName} ${studentLastName}`;
            scheduleEnroll.textContent = enrollmentNo;
            scheduleSemester.textContent = semester;
            scheduleDate.textContent = today;
            scheduleCoursesBody.innerHTML = ''; // Очистить предыдущие строки
            selectedCourses.forEach(course => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-slate-700');
                row.innerHTML = `
                    <td class="py-2 px-2">${course.code}</td>
                    <td class="py-2 px-2">${course.name}</td>
                    <td class="py-2 px-2">${course.location}</td>
                `;
                scheduleCoursesBody.appendChild(row);
            });


            // Запустить генерацию изображений параллельно
            statusText.textContent = 'Генерация изображений...';
            const imagePrompts = {
                idCardPhoto: `${isMale ? 'male' : 'female'} student photo, professional passport style, Brazil university student, clear background`,
                receiptSignature: 'realistic authorized signature',
                scheduleSignature: 'realistic authorized signature'
            };

            await Promise.all([
                generateImage(imagePrompts.idCardPhoto, idCardPhoto, 'Загрузка...'),
                generateImage(imagePrompts.receiptSignature, receiptSignature, 'Загрузка...'),
                generateImage(imagePrompts.scheduleSignature, scheduleSignature, 'Загрузка...')
            ]);
            
            // Убираем анимацию "загрузки" после обновления
            setTimeout(() => {
                spinner.classList.add('hidden');
                btnText.textContent = 'Сгенерировать документы';
                statusText.textContent = 'Документы готовы!';
                saveBtn.disabled = false;
                
                // Плавно отображаем контейнеры предварительного просмотра
                previewWrappers.forEach(el => el.classList.add('visible'));

            }, 1000);
            
            generateBtn.disabled = false;
        });

        // --- Логика модального окна и сохранения ---
        const startDownload = async () => {
            try {
                saveBtn.disabled = true;
                statusText.textContent = 'Создание файлов...';

                // Генерируем Blob-объекты для PDF-файлов
                const [idCardBlob, receiptBlob, scheduleBlob] = await Promise.all([
                    generatePdfBlob('id-card-content'),
                    generatePdfBlob('fee-receipt-content'),
                    generatePdfBlob('class-schedule-content')
                ]);

                statusText.textContent = 'Подготовка к загрузке...';

                const zip = new JSZip();
                zip.file('cartao_identificacao.pdf', idCardBlob);
                zip.file('recibo_propinas.pdf', receiptBlob);
                zip.file('horario_aulas.pdf', scheduleBlob);

                // Добавить текстовый файл
                zip.file('info.txt', currentTxtContent);

                // Генерируем и скачиваем zip-файл
                statusText.textContent = 'Создание ZIP-архива...';
                const content = await zip.generateAsync({ type: 'blob' });

                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'documentos_universitarios.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                statusText.textContent = 'ZIP-архив успешно скачан!';

            } catch (error) {
                console.error('Ошибка при создании ZIP-архива:', error);
                showMessage("Произошла ошибка при скачивании файла. Пожалуйста, попробуйте еще раз.");
                statusText.textContent = 'Ошибка сохранения.';
            } finally {
                saveBtn.disabled = false;
            }
        };

        // --- Modal and Save Logic ---
        saveBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        confirmSubscriptionBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            startDownload();
        });

    </script>
</body>
</html>
